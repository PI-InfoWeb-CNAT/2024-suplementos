{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}Meu Perfil{% endblock %}

{% block styles %}
    <link rel="stylesheet" href="{% static 'css/perfil.css' %}">
{% endblock %}

{% block sidebar %}
    <ul class="menu">
        <li><a href="/"><i class="bi bi-house-door-fill menu-icon"></i>Página Inicial</a></li>
        <li><a href="{% url 'promocoes' %}"><i class="bi bi-lightning-charge-fill menu-icon"></i>Promoções</a></li>
        <li><a href="/maisvendidos"><i class="bi bi-trophy-fill menu-icon"></i>Mais Vendidos</a></li>
        <li><a href="/meuspedidos"><i class="bi bi-basket3-fill menu-icon"></i>Meus Pedidos</a></li>
        <li><a href="/meusfavoritos"><i class="bi bi-heart-fill menu-icon"></i>Meus Favoritos</a></li>
        <li><a href="/perfil" class="active"><i class="bi bi-person-fill menu-icon"></i>Meu Perfil</a></li>
    </ul> 
{% endblock %}

{% block content %}
    <main class="main-perfil">
        <div class="container-cima">
            <h3>Meus Dados</h3>
            <section class="container-botoes-cima">
                <a href="/notificacoes"><i class="bi bi-bell-fill icon-cima"></i></a>
                <a href="/carrinho"><i class="bi bi-cart-fill icon-cima"></i></a>
                <a class="ola-usuario" href="/perfil">Olá, <span>{{ user.username|first_name }}</span><i class="bi bi-chevron-down"></i></a>
            </section>
        </div>
        {% if messages %}
            {% for message in messages %} 
                <div class="message {{ message.tags }}">
                    <span id="messages-dados">{{ message }}</span>
                </div>
            {% endfor %}
        {% endif %}
        <div class="container-flex">
            <section class="container-dados-usuario">
                <h4>Dados Pessoais</h4>
                <div class="container-flex dados">
                    <form action="{% url 'edit' %}" method="POST" class="form-editardados">
                        {% csrf_token %}
                        <label for="nome-dados">Nome: <input type="text" name="nome" id="nome-dados" value="{{nome}}"></label>
                        <label for="email">E-mail: <input type="text" name="email" id="email" value="{{email}}"></label>
                        <p>CPF: <span>{{cpf}}</span></p>
                        <label for="tel_celular">Telefone Celular: <input type="text" name="tel_celular" id="tel_celular" value="{{tel_celular}}"></label>
                        <button type="submit">Atualizar</button>
                    </form>
                    <img src="{% static 'images/imagem-editar.svg' %}" alt="" class="img-editar">
                </div>
            </section>
            <section class="container-menu-secundario">
                <h4>Mais Opções</h4>
                <div class="menu-secundario">
                    <div class="item-menu-secundario">
                        <a href="" class="active"><i class="bi bi-person-fill"></i></a>
                        <p>Meus Dados</p>
                    </div>
                    <div class="item-menu-secundario">
                        <a href=""><i class="bi bi-basket3-fill"></i></a>
                        <p>Meus Pedidos</p>
                    </div>
                    <div class="item-menu-secundario">
                        <a href=""><i class="bi bi-heart-fill menu-icon"></i></a>
                        <p>Meus Favoritos</p>
                    </div>
                    <div class="item-menu-secundario">
                        <a href=""><i class="bi bi-wallet2"></i></a>
                        <p>Minha Carteira</p>
                    </div>
                    <div class="item-menu-secundario">
                        <a href=""><i class="bi bi-bell-fill"></i></a>
                        <p>Notificações</p>
                    </div>
                    <div class="item-menu-secundario">
                        <a href=""><i class="bi bi-bag-check-fill"></i></a>
                        <p>Comprar novamente</p>
                    </div>
                </div>
            </section>
        </div>
        <section class="container-enderecos">
            <h4>Endereços</h4>
            <div class="enderecos">
                {% for endereco in enderecos %}
                    <div class="card-endereco">
                        <h6>{{endereco.nome}}</h6>
                        <div class="endereco-dados">
                            <p>Cidade: <span>{{endereco.cidade}}, {{endereco.estado}}</span></p>
                            <p>Rua: <span>{{endereco.rua}}, {{endereco.numero}}</span></p>
                            <p>CEP: <span>{{endereco.cep}}</span></p>
                            {% if endereco.complemento != '' %}
                                <p>Complemento: <span>{{endereco.complemento}}</span></p>
                            {% else %}
                                <p>Complemento: <span>Vazio</span></p>
                            {% endif %}
                            {% if endereco.telefone != '' %}
                                <p>Telefone: <span>{{endereco.telefone}}</span></p>
                            {% else %}
                                <p>Telefone: <span>Vazio</span></p>
                            {% endif %}
                        </div>
                        <div class="container-buttons">
                            <button type="submit" class="button-submit">Editar</button>
                            <button class="button-excluir">Excluir</button>
                        </div>
                    </div>
                {% endfor %}
                <a class="card-novo-endereco" onclick="abrirAddEndereco()">
                    <i class="bi bi-plus-circle"></i>
                    <p>Adicione um novo endereço</p>
                </a>
                <!-- POP UP -->
                <div class="novoendereco-popup popup">
                    <div>
                        <i class="bi bi-x" onclick="fecharAddEndereco()"></i>
                        <div class="conteudo-popUpNovoEndereco">
                            {% if messages %}
                                {% for message in messages %} 
                                    <div class="message {{ message.tags }}">
                                        <span id="messages-endereco">{{ message }}</span>
                                    </div>
                                {% endfor %}
                            {% endif %}
                            <h5>Adicione novo local de endereço</h5>
                            <form action="{% url 'adicionar-endereco' %}" method="POST">
                                {% csrf_token %}
                                <label for="nome-endereco">Nome:* <input type="text" name="nome" id="nome-endereco" placeholder="Digite o nome do endereço. Ex.: Casa, endereço principal..."></label>
                                <div class="container-flex">
                                    <label for="cep">CEP:* <input type="text" name="cep" id="cep" placeholder="Digite o CEP" onblur="preencher()"></label>
                                    <label for="estado">Estado:* <input type="text" name="estado" id="estado" placeholder="Digite o estado"></label>
                                    <label for="cidade">Cidade:* <input type="text" name="cidade" id="cidade" placeholder="Digite a cidade"></label>
                                </div>
                                <div class="container-flex">
                                    <label for="rua">Rua:* <input type="text" name="rua" id="rua" placeholder="Digite a rua"></label>
                                    <label for="numero">Número:* <input type="text" name="numero" id="numero" placeholder="Digite o número do endereço"></label>
                                </div>
                                <div class="container-flex">
                                    <label for="complemento">Complemento: <input type="text" name="complemento" id="complemento" placeholder="Digite o complemento"></label>
                                    <label for="telefone">Telefone: <input type="text" name="telefone" id="telefone" placeholder="Digite o telefone de contato"></label>
                                </div>
                                <div class="container-buttons">
                                    <button type="submit" class="button-submit">Adicionar</button>
                                    <button onclick="fecharAddEndereco()" class="button-cancelar">Cancelar</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <section class="container-logout">
            <a href="{% url 'logout' %}"><i class="bi bi-box-arrow-right"></i>Sair</a>
            <a onclick="abrirExcluir()"><i class="bi bi-trash3-fill"></i>Excluir Conta</a>
            <div class="excluirconta-popup popup">
                <div>
                    <i class="bi bi-x" onclick="fecharExcluir()"></i>
                    <div class="conteudo-popupExcluir">
                        <p>Deseja realmente excluir a conta?</p>
                        <p><b>Essa é uma ação permanente.</b></p>
                        <i class="bi bi-exclamation-triangle-fill"></i>
                        <div>
                            <button onclick="fecharExcluir()" class="button-cancelar">Cancelar</button>
                            <form action="{% url 'excluir' %}" method="POST">
                                {% csrf_token %}
                                <button type="submit" class="button-excluir">Excluir</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>
{% endblock %}

{% block script %}
    <script src="{% static 'js/perfil.js' %}"></script>
    <script>
        let cepInput = document.getElementById('cep')
        
        function preencher() {
            cep = cepInput.value
            
            if (cep.length === 8) {
                let url = 'https://viacep.com.br/ws/' + cep + '/json/';
        
                fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (!data.erro) {
                        document.getElementById('rua').value = data.logradouro;
                        document.getElementById('cidade').value = data.localidade;
                        document.getElementById('estado').value = data.uf;
                    } else {
                        alert('CEP não encontrado!');
                    }
                })
                .catch(error => {
                    alert('Erro ao buscar o CEP. Verifique o CEP digitado ou tente novamente.');
                    console.error(error);
                });
            } else {
                alert('Por favor, insira um CEP válido com 8 dígitos.');
            }
        }
    </script>
{% endblock %}